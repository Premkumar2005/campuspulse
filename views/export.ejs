<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header') %>
</head>
<body>

<%- include('partials/navbar') %>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-7">

      <!-- Page Title -->
      <div class="mb-4">
        <h4 class="fw-bold">
          <i class="bi bi-download me-2 text-success"></i>
          Export Analytics Report
        </h4>
        <p class="text-muted">
          Select a date range and report type to download CSV
        </p>
      </div>

      <!-- Alert Messages -->
      <% if (error) { %>
        <div class="alert alert-danger alert-dismissible fade show">
          <i class="bi bi-exclamation-circle me-2"></i><%= error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Export Form Card -->
      <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body p-4">

          <form action="/export/download" method="POST">

            <!-- Date Range -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  <i class="bi bi-calendar me-1"></i>Start Date
                </label>
                <input
                  type="date"
                  name="start_date"
                  class="form-control"
                  required
                >
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  <i class="bi bi-calendar-check me-1"></i>End Date
                </label>
                <input
                  type="date"
                  name="end_date"
                  class="form-control"
                  required
                >
              </div>
            </div>

            <!-- Export Type -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-table me-1"></i>Report Type
              </label>
              <div class="row g-2">

                <!-- Event Summary -->
                <div class="col-md-4">
                  <input type="radio" class="btn-check"
                    name="export_type"
                    id="type1"
                    value="event_summary"
                    checked>
                  <label class="btn btn-outline-primary w-100 text-start p-3"
                    for="type1">
                    <i class="bi bi-bar-chart-fill d-block fs-4 mb-1"></i>
                    <strong>Event Summary</strong>
                    <div class="small text-muted mt-1">
                      Daily counts by event type
                    </div>
                  </label>
                </div>

                <!-- User Engagement -->
                <div class="col-md-4">
                  <input type="radio" class="btn-check"
                    name="export_type"
                    id="type2"
                    value="user_engagement">
                  <label class="btn btn-outline-success w-100 text-start p-3"
                    for="type2">
                    <i class="bi bi-people-fill d-block fs-4 mb-1"></i>
                    <strong>User Engagement</strong>
                    <div class="small text-muted mt-1">
                      Per user activity stats
                    </div>
                  </label>
                </div>

                <!-- Raw Events -->
                <div class="col-md-4">
                  <input type="radio" class="btn-check"
                    name="export_type"
                    id="type3"
                    value="raw_events">
                  <label class="btn btn-outline-danger w-100 text-start p-3"
                    for="type3">
                    <i class="bi bi-database-fill d-block fs-4 mb-1"></i>
                    <strong>Raw Events</strong>
                    <div class="small text-muted mt-1">
                      Full event log data
                    </div>
                  </label>
                </div>

              </div>
            </div>

            <!-- Preview Info -->
            <div class="alert alert-light border mb-4">
              <div class="small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Event Summary</strong> →
                  date, event_type, total_count<br>
                <i class="bi bi-info-circle me-1"></i>
                <strong>User Engagement</strong> →
                  name, email, role, total_events, last_active<br>
                <i class="bi bi-info-circle me-1"></i>
                <strong>Raw Events</strong> →
                  id, user_name, email, event_type, route, timestamp
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success px-4">
                <i class="bi bi-download me-2"></i>Download CSV
              </button>
              <a href="/dashboard" class="btn btn-outline-secondary px-4">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
              </a>
            </div>

          </form>
        </div>
      </div>

      <!-- Quick Presets -->
      <div class="card border-0 shadow-sm rounded-3 mt-3">
        <div class="card-body p-3">
          <div class="small fw-semibold mb-2 text-muted">
            Quick Date Presets
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-secondary btn-sm"
              onclick="setDates(0)">Today</button>
            <button class="btn btn-outline-secondary btn-sm"
              onclick="setDates(7)">Last 7 Days</button>
            <button class="btn btn-outline-secondary btn-sm"
              onclick="setDates(30)">Last 30 Days</button>
            <button class="btn btn-outline-secondary btn-sm"
              onclick="setDates(90)">Last 90 Days</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // ── Quick date preset helper ──────────────────
  function setDates(days) {
    const end   = new Date();
    const start = new Date();
    start.setDate(start.getDate() - days);

    const format = d => d.toISOString().split('T')[0];

    document.querySelector('[name="start_date"]').value = format(start);
    document.querySelector('[name="end_date"]').value   = format(end);
  }

  // Set default to last 7 days on load
  window.onload = () => setDates(7);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>